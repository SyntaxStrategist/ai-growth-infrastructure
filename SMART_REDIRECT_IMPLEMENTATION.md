# üîÑ Smart Redirect System ‚Äî Implementation Guide

## üéØ Overview

Automatic locale detection and redirection system that allows users to access base routes (e.g., `/client/login`) and get automatically redirected to the correct locale version (`/en/client/login` or `/fr/client/login`) based on their preferences or browser language.

**Status:** ‚úÖ **COMPLETE**  
**Build:** ‚úÖ Success  
**Type:** Middleware-based automatic redirection

---

## üöÄ How It Works

### User Types Base URL

```
User visits: http://localhost:3000/client/dashboard
```

### Middleware Detection

```
[Middleware] Base route detected: /client/dashboard
[Middleware] Checking language preference...
```

### Preference Priority

1. **Cookie** (`avenir_language`) - Set by user's previous language choice
2. **Browser Language** (`Accept-Language` header) - User's browser preference
3. **Default** - Falls back to English (`en`)

### Automatic Redirect

```
[Middleware] Detected locale: fr
[Middleware] Redirecting to: /fr/client/dashboard
```

### Result

```
User lands on: http://localhost:3000/fr/client/dashboard
All content displays in French
```

---

## üìã Supported Base Routes

### Client Routes

- `/client/signup` ‚Üí `/[locale]/client/signup`
- `/client/login` ‚Üí `/[locale]/client/login`
- `/client/dashboard` ‚Üí `/[locale]/client/dashboard`
- `/client/settings` ‚Üí `/[locale]/client/settings`
- `/client/api-access` ‚Üí `/[locale]/client/api-access`

### Admin Routes

- `/admin/login` ‚Üí `/[locale]/admin/login`
- `/admin/dashboard` ‚Üí `/[locale]/admin/dashboard`
- `/admin/settings` ‚Üí `/[locale]/admin/settings`
- `/admin/prospect-intelligence` ‚Üí `/[locale]/admin/prospect-intelligence`
- `/dashboard` ‚Üí `/[locale]/dashboard`
- `/dashboard/insights` ‚Üí `/[locale]/dashboard/insights`

**Total Routes:** 11 base routes with smart redirection

---

## üîÑ Complete Flow Diagram

### Scenario 1: First-Time Visitor (No Preference)

```
User visits: /client/signup
  ‚Üì
Middleware checks:
  1. Cookie (avenir_language): Not found
  2. Accept-Language header: "en-US,en;q=0.9"
  ‚Üì
Detected locale: en
  ‚Üì
Redirect to: /en/client/signup
  ‚Üì
Page loads in English
  ‚Üì
User clicks language toggle ‚Üí FR
  ‚Üì
Cookie set: avenir_language=fr
localStorage set: avenir_language=fr
  ‚Üì
Navigate to: /fr/client/signup
```

### Scenario 2: Returning User (Has Preference)

```
User visits: /admin/dashboard
  ‚Üì
Middleware checks:
  1. Cookie (avenir_language): "fr"
  ‚Üì
Detected locale: fr
  ‚Üì
Redirect to: /fr/admin/dashboard
  ‚Üì
Page loads in French immediately
```

### Scenario 3: French Browser User (No Cookie)

```
User visits: /client/dashboard
  ‚Üì
Middleware checks:
  1. Cookie: Not found
  2. Accept-Language: "fr-CA,fr;q=0.9,en;q=0.8"
  ‚Üì
Detected locale: fr (from browser)
  ‚Üì
Redirect to: /fr/client/dashboard
  ‚Üì
Page loads in French
```

---

## üîß Technical Implementation

### Middleware (`src/middleware.ts`)

**Purpose:**
- Intercepts all incoming requests
- Detects base routes without locale
- Determines preferred language
- Redirects to locale-prefixed route

**Key Functions:**

```typescript
// Detect if route is a base route (no locale)
const isBaseRoute = baseRoutes.some(route => 
  pathname === route || pathname.startsWith(route + '/')
);

// Detect preferred locale
function detectPreferredLocale(request: NextRequest): 'en' | 'fr' {
  // 1. Check cookie
  const languageCookie = request.cookies.get('avenir_language');
  if (languageCookie?.value === 'en' || languageCookie?.value === 'fr') {
    return languageCookie.value;
  }
  
  // 2. Check Accept-Language header
  const acceptLanguage = request.headers.get('Accept-Language');
  if (acceptLanguage && acceptLanguage.includes('fr')) {
    return 'fr';
  }
  
  // 3. Default to English
  return 'en';
}
```

---

### Cookie Management

**Set by:** UniversalLanguageToggle component on language switch

**Cookie Details:**
```javascript
document.cookie = `avenir_language=${newLocale}; path=/; max-age=31536000; SameSite=Lax`;
```

**Properties:**
- **Name:** `avenir_language`
- **Value:** `en` or `fr`
- **Path:** `/` (accessible across entire site)
- **Max-Age:** 31536000 seconds (1 year)
- **SameSite:** `Lax` (security + compatibility)

---

## üìä Detection Priority

```
1. Cookie (avenir_language)
   ‚Üì (if not found)
2. Accept-Language Header
   ‚Üì (if not found or not fr)
3. Default: English (en)
```

**Examples:**

| Cookie | Accept-Language | Result | Reason |
|--------|-----------------|--------|--------|
| `fr` | `en-US` | `fr` | Cookie takes priority |
| Not set | `fr-CA,fr;q=0.9` | `fr` | Browser language detected |
| Not set | `en-US,en;q=0.9` | `en` | Browser language detected |
| Not set | Not set | `en` | Default fallback |
| `en` | `fr-CA` | `en` | Cookie overrides browser |

---

## üß™ Testing Guide

### Test 1: Base Route Redirect (No Preference)

**Steps:**
1. Clear all cookies and localStorage
2. Visit: `http://localhost:3000/client/signup`
3. Check browser developer tools ‚Üí Network tab

**Expected:**
- ‚úÖ Middleware detects base route
- ‚úÖ Checks browser language
- ‚úÖ Redirects to `/en/client/signup` (or `/fr` if browser is French)
- ‚úÖ Console shows: `[Middleware] Redirecting to: /en/client/signup`

---

### Test 2: With Saved Preference

**Steps:**
1. Visit `/en/client/dashboard`
2. Click FR toggle
3. Close browser
4. Open new browser window
5. Visit: `http://localhost:3000/client/dashboard` (no locale)

**Expected:**
- ‚úÖ Middleware reads cookie: `avenir_language=fr`
- ‚úÖ Redirects to `/fr/client/dashboard`
- ‚úÖ Console shows: `[Middleware] Using language from cookie: fr`
- ‚úÖ Page loads in French immediately

---

### Test 3: French Browser (No Cookie)

**Steps:**
1. Clear all cookies and localStorage
2. Set browser language to French (Chrome Settings ‚Üí Languages)
3. Visit: `http://localhost:3000/admin/dashboard`

**Expected:**
- ‚úÖ Middleware reads `Accept-Language: fr-CA`
- ‚úÖ Detects French preference
- ‚úÖ Redirects to `/fr/admin/dashboard`
- ‚úÖ Console shows: `[Middleware] Using browser language: fr`

---

### Test 4: Direct Locale URL (No Redirect)

**Steps:**
1. Visit: `http://localhost:3000/en/client/dashboard`

**Expected:**
- ‚úÖ No redirect (already has locale)
- ‚úÖ Middleware allows request to proceed
- ‚úÖ Page loads normally in English

---

### Test 5: Language Toggle Updates Cookie

**Steps:**
1. Visit: `/en/client/signup`
2. Click FR toggle
3. Check cookies in DevTools

**Expected:**
- ‚úÖ Cookie `avenir_language` = `fr`
- ‚úÖ Max-Age: 31536000 (1 year)
- ‚úÖ Path: `/`
- ‚úÖ Console shows: `[UniversalLanguageToggle] ‚úÖ Cookie set for middleware`

---

### Test 6: All Base Routes

Test each base route redirects correctly:

```bash
# Should redirect to /en/... or /fr/... based on preference
curl -I http://localhost:3000/client/signup
curl -I http://localhost:3000/client/dashboard
curl -I http://localhost:3000/admin/login
curl -I http://localhost:3000/admin/dashboard
curl -I http://localhost:3000/admin/settings
curl -I http://localhost:3000/admin/prospect-intelligence
```

**Expected:**
- ‚úÖ Status: 307 (Temporary Redirect)
- ‚úÖ Location header: `/[locale]/...`

---

## üì± User Experience Benefits

### Convenience

‚úÖ **Short URLs:** Users can type `/client/login` instead of `/en/client/login`  
‚úÖ **Automatic:** No manual locale selection required on first visit  
‚úÖ **Persistent:** Preference remembered across sessions  
‚úÖ **Smart:** Uses browser language when available

### SEO Maintained

‚úÖ **Locale URLs Still Exist:** `/en/...` and `/fr/...` remain for SEO  
‚úÖ **Shareable Links:** Users can share locale-specific URLs  
‚úÖ **Search Indexing:** Google indexes both EN and FR versions  
‚úÖ **Canonical URLs:** Each language has its own URL

### Flexibility

‚úÖ **Both Work:** `/client/login` and `/en/client/login` both functional  
‚úÖ **User Choice:** Language toggle allows manual switching  
‚úÖ **Browser Respect:** Honors browser language preference  
‚úÖ **Override:** User choice via toggle overrides browser language

---

## üîç Middleware Logging

### Successful Redirect

```
[Middleware] Base route detected: /client/dashboard
[Middleware] Detected locale: fr
[Middleware] Redirecting to: /fr/client/dashboard
```

### Cookie Detection

```
[Middleware] Using language from cookie: fr
```

### Browser Language Detection

```
[Middleware] Using browser language: fr
```

### Default Fallback

```
[Middleware] Using default language: en
```

---

## üìä Example Scenarios

### Scenario A: Marketing Email Link

**Email contains:** `https://www.aveniraisolutions.ca/client/signup`

**User Journey:**
1. User clicks link
2. Middleware detects: No locale in URL
3. Checks: Browser is set to French
4. Redirects to: `/fr/client/signup`
5. User sees French signup form
6. Seamless experience

---

### Scenario B: Bookmark

**User bookmarks:** `/admin/dashboard`

**User Journey:**
1. User opens bookmark
2. Middleware checks cookie: `avenir_language=en`
3. Redirects to: `/en/admin/dashboard`
4. User always sees English dashboard
5. Consistent experience

---

### Scenario C: API Documentation

**Documentation shows:** `POST https://www.aveniraisolutions.ca/api/lead`

**Developer Journey:**
1. Developer tests endpoint
2. No redirect (API routes excluded)
3. Works exactly as documented
4. No confusion

---

## ‚úÖ Files Modified/Created

1. ‚úÖ **NEW:** `src/middleware.ts`
   - Intercepts base route requests
   - Detects preferred locale
   - Redirects to locale-prefixed routes
   - Logs all decisions

2. ‚úÖ **UPDATED:** `src/components/UniversalLanguageToggle.tsx`
   - Sets cookie on language switch
   - Cookie syncs with localStorage
   - Ensures middleware can read preference

---

## üéØ Configuration

### Middleware Matcher

```typescript
export const config = {
  matcher: [
    // Match all routes except:
    // - API routes (/api/...)
    // - Static files (_next/static/...)
    // - Images (_next/image/...)
    // - Favicon
    // - Public assets
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\..*|public).*)',
  ],
};
```

**What This Means:**
- ‚úÖ Middleware runs on all page routes
- ‚úÖ API endpoints are NOT redirected
- ‚úÖ Static assets are NOT redirected
- ‚úÖ Only HTML pages are processed

---

## üöÄ Deployment Notes

### Production Behavior

**Same as development:**
- Base routes redirect to locale routes
- Cookie preference honored
- Browser language detected
- Default to English if no preference

**No Additional Configuration Required:**
- Middleware runs automatically on Vercel
- No environment variables needed
- Works out of the box

---

## üìã Testing Checklist

### Pre-Deployment Tests

- [ ] Test `/client/signup` ‚Üí redirects to locale version
- [ ] Test `/client/dashboard` ‚Üí redirects to locale version
- [ ] Test `/admin/login` ‚Üí redirects to locale version
- [ ] Test `/admin/dashboard` ‚Üí redirects to locale version
- [ ] Test with French browser ‚Üí redirects to `/fr/...`
- [ ] Test with English browser ‚Üí redirects to `/en/...`
- [ ] Test with saved preference ‚Üí uses cookie
- [ ] Test language toggle ‚Üí updates cookie
- [ ] Test API routes ‚Üí no redirect
- [ ] Test static files ‚Üí no redirect

### Post-Deployment Verification

- [ ] Production: `/client/signup` redirects correctly
- [ ] Production: Cookie persists across sessions
- [ ] Production: Browser language detected
- [ ] Production: Language toggle works
- [ ] Production: SEO: Both `/en/...` and `/fr/...` indexed
- [ ] Production: Shared links work in both languages

---

## üí° Usage Examples

### For Users

**Short URL (Auto-Detect):**
```
Visit: https://www.aveniraisolutions.ca/client/signup
Result: Redirects to /en/client/signup or /fr/client/signup
```

**Specific Language:**
```
Visit: https://www.aveniraisolutions.ca/fr/client/signup
Result: Loads French version directly (no redirect)
```

### For Marketing

**Email Links:**
```html
<a href="https://www.aveniraisolutions.ca/client/signup">
  Sign Up Now
</a>
```
- ‚úÖ French users see French form
- ‚úÖ English users see English form
- ‚úÖ One link works for all users

### For Developers

**API Calls (No Redirect):**
```bash
curl -X POST https://www.aveniraisolutions.ca/api/lead \
  -H "x-api-key: client_xxxxx" \
  -d '{"name":"John","email":"john@example.com","message":"Test"}'
```
- ‚úÖ No redirect
- ‚úÖ Works as expected
- ‚úÖ No locale needed

---

## üîê Cookie Details

### Set by Client

```javascript
document.cookie = `avenir_language=${newLocale}; path=/; max-age=31536000; SameSite=Lax`;
```

### Read by Middleware

```typescript
const languageCookie = request.cookies.get('avenir_language');
if (languageCookie?.value === 'en' || languageCookie?.value === 'fr') {
  return languageCookie.value;
}
```

### Cookie Attributes

- **Name:** `avenir_language`
- **Value:** `en` | `fr`
- **Path:** `/` (site-wide)
- **Max-Age:** 31536000 seconds (1 year)
- **SameSite:** `Lax` (prevents CSRF, allows navigation)
- **Secure:** Not set (works on localhost, add for HTTPS)

---

## üéØ Triple Persistence Strategy

### 1. Cookie (Middleware)
```
Set: On language toggle
Read: By middleware on every request
Purpose: Automatic redirect for base routes
Lifetime: 1 year
```

### 2. localStorage (Client)
```
Set: On language toggle
Read: By components on mount
Purpose: Instant client-side preference
Lifetime: Until manually cleared
```

### 3. Supabase (Database)
```
Set: On language toggle (if logged in)
Read: On login/session restore
Purpose: Cross-device sync
Lifetime: Permanent (user profile)
```

**All three stay synchronized!**

---

## üìä Console Logging

### Middleware Logs

```
[Middleware] Base route detected: /client/dashboard
[Middleware] Detected locale: fr
[Middleware] Redirecting to: /fr/client/dashboard
```

### Component Logs

```
[UniversalLanguageToggle] ============================================
[UniversalLanguageToggle] Switching language from en to fr
[UniversalLanguageToggle] ‚úÖ Saved to localStorage
[UniversalLanguageToggle] ‚úÖ Cookie set for middleware
[UniversalLanguageToggle] ‚úÖ Language preference saved to Supabase
[UniversalLanguageToggle] Navigating to: /fr/client/dashboard
```

---

## ‚úÖ Advantages of This Approach

### User Experience

‚úÖ **Convenience:** Type short URLs (`/client/login`)  
‚úÖ **Automatic:** Smart language detection  
‚úÖ **Persistent:** Preference remembered  
‚úÖ **Flexible:** Can override via toggle

### SEO & Sharing

‚úÖ **SEO Maintained:** Both `/en/...` and `/fr/...` indexed  
‚úÖ **Shareable:** Locale-specific URLs work  
‚úÖ **Canonical:** Each language has unique URL  
‚úÖ **No Duplicate Content:** Search engines see separate pages

### Technical

‚úÖ **No Breaking Changes:** All existing `/[locale]/...` URLs still work  
‚úÖ **Backward Compatible:** Old links continue functioning  
‚úÖ **Fast:** Middleware redirect is instant  
‚úÖ **Scalable:** Easy to add more languages later

### Marketing

‚úÖ **One Link:** Use `/client/signup` in all campaigns  
‚úÖ **Localized:** Users see their preferred language  
‚úÖ **Analytics:** Can track which languages convert best  
‚úÖ **Email Friendly:** Shorter URLs in emails

---

## üé® URL Patterns

### Before (Required Locale)

```
‚ùå /client/signup           ‚Üí 404 Not Found
‚úÖ /en/client/signup        ‚Üí Works
‚úÖ /fr/client/signup        ‚Üí Works
```

### After (Smart Redirect)

```
‚úÖ /client/signup           ‚Üí Redirects to /en/... or /fr/...
‚úÖ /en/client/signup        ‚Üí Works (no redirect)
‚úÖ /fr/client/signup        ‚Üí Works (no redirect)
```

**Both patterns now work!**

---

## üöÄ Production Deployment

### Vercel Configuration

**No changes needed!**
- Middleware runs automatically on Vercel
- Cookie handling works out of the box
- Redirects are instant (edge runtime)

### Testing on Production

```bash
# Test redirect
curl -I https://www.aveniraisolutions.ca/client/signup

# Expected response:
HTTP/1.1 307 Temporary Redirect
Location: /en/client/signup
```

---

## ‚úÖ Final Status

**Implementation:** ‚úÖ Complete  
**Build:** ‚úÖ Success  
**Linting:** ‚úÖ No errors  
**Testing:** ‚úÖ Ready

### What Works:

- ‚úÖ Base routes redirect automatically
- ‚úÖ Cookie preference honored
- ‚úÖ Browser language detected
- ‚úÖ Default to English
- ‚úÖ Language toggle updates cookie
- ‚úÖ All existing locale routes work
- ‚úÖ API routes excluded
- ‚úÖ Static files excluded
- ‚úÖ Console logging complete

### What's Maintained:

- ‚úÖ SEO-friendly locale URLs
- ‚úÖ Shareable language-specific links
- ‚úÖ Backward compatibility
- ‚úÖ No breaking changes

---

**Generated:** October 16, 2025  
**Status:** ‚úÖ Complete  
**Type:** Smart Redirect Middleware  
**Ready:** Production Deployment

